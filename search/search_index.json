{"config":{"lang":["en"],"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"another, self-built, home automation system \u00b6 My main focus was a robust, self-sufficient control system with which I could not depend on a proprietary system from a single manufacturer but could expand with hardware / software from different manufacturers. Here my choice fell on Simatic CPUs. The sensors and actuators are wired to these and they process the control program. Via the LAN interface, the CPUs communicate with a NAS running a data logger script. Here various data are stored in a mySQL database for later evaluation. As a central control system I use NodeRed which provides a webserver for operation (and a lot of help during development). Business view \u00b6 Hint Of course I am not liable for any damage caused by replicas ;-)","title":"Auto Home Stack"},{"location":"#another-self-built-home-automation-system","text":"My main focus was a robust, self-sufficient control system with which I could not depend on a proprietary system from a single manufacturer but could expand with hardware / software from different manufacturers. Here my choice fell on Simatic CPUs. The sensors and actuators are wired to these and they process the control program. Via the LAN interface, the CPUs communicate with a NAS running a data logger script. Here various data are stored in a mySQL database for later evaluation. As a central control system I use NodeRed which provides a webserver for operation (and a lot of help during development).","title":"another, self-built, home automation system"},{"location":"#business-view","text":"Hint Of course I am not liable for any damage caused by replicas ;-)","title":"Business view"},{"location":"about/imprint/","text":"Imprint \u00b6 Information according to \u00a7 5 TMG \u00b6 Alexander Kratzer Hintere Pfaffenleite 7 91358 Kunreuth Contact: Phone: 01601572825 E-mail: holzeimer@mail.de Disclaimer of liability \u00b6 Liability for contents \u00b6 The contents of our pages were created with the greatest care. However, we cannot assume any liability for the correctness, completeness and topicality of the contents. As a service provider, we are responsible for our own content on these pages according to \u00a7 7 para.1 TMG (German Telemedia Act) and general laws. According to \u00a7\u00a7 8 to 10 TMG, we are not obliged to monitor transmitted or stored external information or to investigate circumstances that indicate illegal activity. Obligations to remove or block the use of information according to general laws remain unaffected. However, liability in this respect is only possible from the time of knowledge of a concrete infringement. If we become aware of any such infringements, we will remove such content immediately. Liability for links \u00b6 Our offer contains links to external websites of third parties, on whose contents we have no influence. Therefore we cannot assume any liability for these external contents. The respective provider or operator of the sites is always responsible for the contents of the linked sites. The linked pages were checked for possible legal violations at the time of linking. Illegal contents were not recognizable at the time of linking. However, a permanent control of the contents of the linked pages is not reasonable without concrete evidence of a violation of the law. If we become aware of any infringements, we will remove such links immediately. Data protection \u00b6 The use of our website is usually possible without providing personal data. As far as personal data (e.g. name, address or e-mail addresses) is collected on our website, this is always done on a voluntary basis, as far as possible. These data will not be passed on to third parties without your express consent. We would like to point out that data transmission on the Internet (e.g. communication by e-mail) can have security gaps. A complete protection of data against access by third parties is not possible. The use of contact data published within the scope of the imprint obligation by third parties for sending advertising and information material not expressly requested is hereby expressly prohibited. The operators of the pages expressly reserve the right to take legal action in the event of the unsolicited sending of advertising information, for example through spam mails.","title":"Imprint"},{"location":"about/imprint/#imprint","text":"","title":"Imprint"},{"location":"about/imprint/#information-according-to-5-tmg","text":"Alexander Kratzer Hintere Pfaffenleite 7 91358 Kunreuth Contact: Phone: 01601572825 E-mail: holzeimer@mail.de","title":"Information according to \u00a7 5 TMG"},{"location":"about/imprint/#disclaimer-of-liability","text":"","title":"Disclaimer of liability"},{"location":"about/imprint/#liability-for-contents","text":"The contents of our pages were created with the greatest care. However, we cannot assume any liability for the correctness, completeness and topicality of the contents. As a service provider, we are responsible for our own content on these pages according to \u00a7 7 para.1 TMG (German Telemedia Act) and general laws. According to \u00a7\u00a7 8 to 10 TMG, we are not obliged to monitor transmitted or stored external information or to investigate circumstances that indicate illegal activity. Obligations to remove or block the use of information according to general laws remain unaffected. However, liability in this respect is only possible from the time of knowledge of a concrete infringement. If we become aware of any such infringements, we will remove such content immediately.","title":"Liability for contents"},{"location":"about/imprint/#liability-for-links","text":"Our offer contains links to external websites of third parties, on whose contents we have no influence. Therefore we cannot assume any liability for these external contents. The respective provider or operator of the sites is always responsible for the contents of the linked sites. The linked pages were checked for possible legal violations at the time of linking. Illegal contents were not recognizable at the time of linking. However, a permanent control of the contents of the linked pages is not reasonable without concrete evidence of a violation of the law. If we become aware of any infringements, we will remove such links immediately.","title":"Liability for links"},{"location":"about/imprint/#data-protection","text":"The use of our website is usually possible without providing personal data. As far as personal data (e.g. name, address or e-mail addresses) is collected on our website, this is always done on a voluntary basis, as far as possible. These data will not be passed on to third parties without your express consent. We would like to point out that data transmission on the Internet (e.g. communication by e-mail) can have security gaps. A complete protection of data against access by third parties is not possible. The use of contact data published within the scope of the imprint obligation by third parties for sending advertising and information material not expressly requested is hereby expressly prohibited. The operators of the pages expressly reserve the right to take legal action in the event of the unsolicited sending of advertising information, for example through spam mails.","title":"Data protection"},{"location":"about/plc_lib_interface/","text":"plc FB lib \u00b6 aktor light \u00b6 udp interface -|-|- logic interface -|-|- aktor heater \u00b6 distributor upper floor circuit room location length 1 child east wall 87 2 child west wall 86 3 north west wall 88 4 bath wall 94 5 - - - 6 bath floor 51 distributor ground floor circuit room location length 1 entrance floor ? 2 office wall 112 3 living room wall 111 4 kitchen, dining wall 130 5 - - - 6 - - -","title":"plc lib"},{"location":"about/plc_lib_interface/#plc-fb-lib","text":"","title":"plc FB lib"},{"location":"about/plc_lib_interface/#aktor-light","text":"udp interface -|-|- logic interface -|-|-","title":"aktor light"},{"location":"about/plc_lib_interface/#aktor-heater","text":"distributor upper floor circuit room location length 1 child east wall 87 2 child west wall 86 3 north west wall 88 4 bath wall 94 5 - - - 6 bath floor 51 distributor ground floor circuit room location length 1 entrance floor ? 2 office wall 112 3 living room wall 111 4 kitchen, dining wall 130 5 - - - 6 - - -","title":"aktor heater"},{"location":"about/references/","text":"Links / Downlads \u00b6 type info format link docu this documentation at AWS markdown autohomestack.de docu this documentation at github markdown alexkratzer.github.io/autohomestack/ repo this repository at github github.com/alexkratzer/autohomestack tool home automation pc-tool (outdated) dotNet github.com/alexkratzer/ahGUI tool pc - plc adapter dotNet github.com/alexkratzer/CpuPcStack config node-RED flows json github.com/ ... /node_red_flows","title":"References"},{"location":"about/references/#links-downlads","text":"type info format link docu this documentation at AWS markdown autohomestack.de docu this documentation at github markdown alexkratzer.github.io/autohomestack/ repo this repository at github github.com/alexkratzer/autohomestack tool home automation pc-tool (outdated) dotNet github.com/alexkratzer/ahGUI tool pc - plc adapter dotNet github.com/alexkratzer/CpuPcStack config node-RED flows json github.com/ ... /node_red_flows","title":"Links / Downlads"},{"location":"about/topics_node/","text":"topics \u00b6 device-type device-value plc eg, og, car, esp basement, carport, .. netatmo base, outside, rain rpi3 self, media_eg, media_bath, media_hall component-type component-value description dl weather, sensor, aktor data logger events status error, self, ... i sensor_name, e.g. light_barrier, motion_sensor input values o aktor_name, e.g. light_bath_ceiling output values get global device values, e.g. get_all get from device set global device cmd, e.g. set_verbose set to device logging at DB \u00b6 All topics containing /status/log will be stored at table node_status_log v01/netatmo/base/status/log v01/netatmo/outdoor/status/log v01/netatmo/rain/status/log v01/rpi/4/status/log v01/rpi/OG_floor/status/log v01/rpi/EG_living/status/log v01/rpi/OG_bath/status/log general structure of messages \u00b6 version device-type device-value component-type component-value example msg v01 plc eg dl eta v01 plc eg pd eta v01 plc eg status error v01 esp basement i pir1 v01 esp basement dl pir1 plc -> node_red \u00b6 plc function NodeSend___send() add prefix to topic v01/plc/ device-value is added from node_red while receiving (from IP address) example v01/plc/og/o/light/stairs_west v01/plc/eg/i/NodeDiFlag component-type component-value message description pd eta values of ProzessData all pd components are filtert from node_log status error name + value description of error status => use FC NodeSend_status/error dl eta values maybe redundant to pd/eta ==> current deactivated at PLC o heater/bath i [input name] {switches:value} plc detected input change (button, pir sensor, and so on...) i cmd_local [cmd name] cmd from local input i cmd_remote [cmd name] cmd from remote plc input node_red -> plc \u00b6 iot -> node_red \u00b6 node_red -> iot \u00b6","title":"node topics"},{"location":"about/topics_node/#topics","text":"device-type device-value plc eg, og, car, esp basement, carport, .. netatmo base, outside, rain rpi3 self, media_eg, media_bath, media_hall component-type component-value description dl weather, sensor, aktor data logger events status error, self, ... i sensor_name, e.g. light_barrier, motion_sensor input values o aktor_name, e.g. light_bath_ceiling output values get global device values, e.g. get_all get from device set global device cmd, e.g. set_verbose set to device","title":"topics"},{"location":"about/topics_node/#logging-at-db","text":"All topics containing /status/log will be stored at table node_status_log v01/netatmo/base/status/log v01/netatmo/outdoor/status/log v01/netatmo/rain/status/log v01/rpi/4/status/log v01/rpi/OG_floor/status/log v01/rpi/EG_living/status/log v01/rpi/OG_bath/status/log","title":"logging at DB"},{"location":"about/topics_node/#general-structure-of-messages","text":"version device-type device-value component-type component-value example msg v01 plc eg dl eta v01 plc eg pd eta v01 plc eg status error v01 esp basement i pir1 v01 esp basement dl pir1","title":"general structure of messages"},{"location":"about/topics_node/#plc-node_red","text":"plc function NodeSend___send() add prefix to topic v01/plc/ device-value is added from node_red while receiving (from IP address) example v01/plc/og/o/light/stairs_west v01/plc/eg/i/NodeDiFlag component-type component-value message description pd eta values of ProzessData all pd components are filtert from node_log status error name + value description of error status => use FC NodeSend_status/error dl eta values maybe redundant to pd/eta ==> current deactivated at PLC o heater/bath i [input name] {switches:value} plc detected input change (button, pir sensor, and so on...) i cmd_local [cmd name] cmd from local input i cmd_remote [cmd name] cmd from remote plc input","title":"plc -&gt; node_red"},{"location":"about/topics_node/#node_red-plc","text":"","title":"node_red -&gt; plc"},{"location":"about/topics_node/#iot-node_red","text":"","title":"iot -&gt; node_red"},{"location":"about/topics_node/#node_red-iot","text":"","title":"node_red -&gt; iot"},{"location":"about/wiki/","text":"some useful hints \u00b6 documentation \u00b6 usage MkDocs \u00b6 mkdocs serve - Start the live-reloading docs server. mkdocs build - Build the documentation site. aws s3 sync ./site s3://autohomestack.de Deploy to s3 bucket mkdocs gh-deploy Deploy your documentation to GitHub Pages localhost:8000 to view it in browser https://autohomestack.github.io/website/ draw.io \u00b6 Open the XML (or create new one) with https://www.draw.io/ Make your changes Export the Image as PNG and get the XML source plantuml \u00b6 @ startuml ( * ) --> \"First Activity\" \"First Activity\" --> ( * ) @ enduml plantuml examples plantuml examples plantuml examples online editor open preview at VSC Ctrl + Shift + N -> to open a new window point to a different root folder Ctrl + Shift + V -> open markdown preview mode Alt + D -> to render plantuml git bash \u00b6 cmd task git checkout -b make new feature branch git checkout Pre_Master merge feature branch to Pre_Master git pull merge feature branch to Pre_Master git merge merge feature branch to Pre_Master git push --delete origin delete feature branch git branch -d delete feature branch","title":"My wiki"},{"location":"about/wiki/#some-useful-hints","text":"","title":"some useful hints"},{"location":"about/wiki/#documentation","text":"","title":"documentation"},{"location":"about/wiki/#usage-mkdocs","text":"mkdocs serve - Start the live-reloading docs server. mkdocs build - Build the documentation site. aws s3 sync ./site s3://autohomestack.de Deploy to s3 bucket mkdocs gh-deploy Deploy your documentation to GitHub Pages localhost:8000 to view it in browser https://autohomestack.github.io/website/","title":"usage MkDocs"},{"location":"about/wiki/#drawio","text":"Open the XML (or create new one) with https://www.draw.io/ Make your changes Export the Image as PNG and get the XML source","title":"draw.io"},{"location":"about/wiki/#plantuml","text":"@ startuml ( * ) --> \"First Activity\" \"First Activity\" --> ( * ) @ enduml plantuml examples plantuml examples plantuml examples online editor open preview at VSC Ctrl + Shift + N -> to open a new window point to a different root folder Ctrl + Shift + V -> open markdown preview mode Alt + D -> to render plantuml","title":"plantuml"},{"location":"about/wiki/#git-bash","text":"cmd task git checkout -b make new feature branch git checkout Pre_Master merge feature branch to Pre_Master git pull merge feature branch to Pre_Master git merge merge feature branch to Pre_Master git push --delete origin delete feature branch git branch -d delete feature branch","title":"git bash"},{"location":"home/components/","text":"Components \u00b6 here another view with focus on interface protocolls","title":"Components"},{"location":"home/components/#components","text":"here another view with focus on interface protocolls","title":"Components"},{"location":"home/requirements/","text":"Requirements to the system \u00b6 Most important \u00b6 Hint In order to gain acceptance among stakeholders, it is absolutely necessary to guarantee the basic functions that are also available with a conventional installation. These basic functions are: Switching the light on / off with conventional switches It must be possible to raise and lower the blinds by pressing buttons Sockets must be switched on moderately by default The heater must heat automatically up to the last set temperature Some more \u00b6 type description robustnes When the system is switched on (e.g. after a power failure) the system itself should start up and be active robustnes Services / applications on servers should be monitored automatically and restarted if necessary robustnes Backups of databases and other artifacts should be created automatically robustnes Basic functions like switching light on/off must work even if the control level or parts of the process level fail interoperability The different components of the system shall provide apis to exchange information and communicate with internal and external applications and systems. interoperability The system shall be open to different transport protocols and publishing / describing interfaces. interoperability For integrating iot devices the system shall provide a MQTT broker. That allows easy w-lan connecting of esp based devices interoperability The PLC shall communicate to sensors / actors hardwired, via modbus, analog voltage signals, ... interoperability The data formats, transport protocols and interfaces shall be derived from central managed masterdata","title":"Requirements"},{"location":"home/requirements/#requirements-to-the-system","text":"","title":"Requirements to the system"},{"location":"home/requirements/#most-important","text":"Hint In order to gain acceptance among stakeholders, it is absolutely necessary to guarantee the basic functions that are also available with a conventional installation. These basic functions are: Switching the light on / off with conventional switches It must be possible to raise and lower the blinds by pressing buttons Sockets must be switched on moderately by default The heater must heat automatically up to the last set temperature","title":"Most important"},{"location":"home/requirements/#some-more","text":"type description robustnes When the system is switched on (e.g. after a power failure) the system itself should start up and be active robustnes Services / applications on servers should be monitored automatically and restarted if necessary robustnes Backups of databases and other artifacts should be created automatically robustnes Basic functions like switching light on/off must work even if the control level or parts of the process level fail interoperability The different components of the system shall provide apis to exchange information and communicate with internal and external applications and systems. interoperability The system shall be open to different transport protocols and publishing / describing interfaces. interoperability For integrating iot devices the system shall provide a MQTT broker. That allows easy w-lan connecting of esp based devices interoperability The PLC shall communicate to sensors / actors hardwired, via modbus, analog voltage signals, ... interoperability The data formats, transport protocols and interfaces shall be derived from central managed masterdata","title":"Some more"},{"location":"images/readme_plantuml/","text":"plantuml code for readme \u00b6 until I get the plant-uml plugin working here is the code to the pictures Components of the auto home stack \u00b6 @ startuml skinparam component { FontColor black AttributeFontColor black FontSize 17 AttributeFontSize 15 AttributeFontname Droid Sans Mono BackgroundColor # 6 A9EFF BorderColor black ArrowColor # 222266 } title auto home stack skinparam componentStyle uml2 node \"user interface\" { frame \"deprecated\" { [ dotnet pc tool ] # Gray } [ dotnet pc tool ] <--> udp_plc [ web client ] < .. > http } cloud { interface www [ AWS ] --> www [ netatmo ] -> www } node \"ahs\" { interface data_logger as data_logger interface mqtt [ data logger server ] as dls [ rpi_nodered ] as nr dls - up -> [ dashboard ] [ dashboard ] -> http dls <-- data_logger www -> nr http <--> nr nr - right -> [ plc_xx ] nr <-> dls nr <- down -> mqtt udp_plc <-> [ plc_xx ] data_logger <- [ plc_xx ] [ plc_xy ] - up -> [ plc_xx ] [ esp ] < . up . > mqtt [ sensor ] - up -> [ plc_xx ] [ aktor ] <- up - [ plc_xx ] } @ enduml legend \u00b6 @ startuml node \"Legend\" { package \"device\" { [ item 1 ] as TMS # Tomato } folder \"tst\" { [ item 2 ] as CM # Lime } } @ enduml node red \u00b6 @ startuml [ * ] --> NodeRed udp -> NodeRed NodeRed -> udp udp : plc interface mqtt --> NodeRed NodeRed --> mqtt mqtt : field level devices \\ nesp 8266 , \\ nwatchdog services , ... iot --> NodeRed NodeRed --> iot iot : other interfaces \\ nlike rest apis , AWS S3 , \\ nssh to linux devices , \\ n ... NodeRed --> db db : MySQL and \\ nInfluxDB NodeRed : store all prozess \\ nand event data \\ nprozess data with rule engine \\ n @ enduml node_red rule engine \u00b6 @ startuml ( * ) --> new event If \"compare topic\" then --> [ matches ] \"create alarm\" --> send to receiver --> ( * ) else --> [ no match ] continue Endif --> ( * ) @ enduml","title":"Plantuml code"},{"location":"images/readme_plantuml/#plantuml-code-for-readme","text":"until I get the plant-uml plugin working here is the code to the pictures","title":"plantuml code for readme"},{"location":"images/readme_plantuml/#components-of-the-auto-home-stack","text":"@ startuml skinparam component { FontColor black AttributeFontColor black FontSize 17 AttributeFontSize 15 AttributeFontname Droid Sans Mono BackgroundColor # 6 A9EFF BorderColor black ArrowColor # 222266 } title auto home stack skinparam componentStyle uml2 node \"user interface\" { frame \"deprecated\" { [ dotnet pc tool ] # Gray } [ dotnet pc tool ] <--> udp_plc [ web client ] < .. > http } cloud { interface www [ AWS ] --> www [ netatmo ] -> www } node \"ahs\" { interface data_logger as data_logger interface mqtt [ data logger server ] as dls [ rpi_nodered ] as nr dls - up -> [ dashboard ] [ dashboard ] -> http dls <-- data_logger www -> nr http <--> nr nr - right -> [ plc_xx ] nr <-> dls nr <- down -> mqtt udp_plc <-> [ plc_xx ] data_logger <- [ plc_xx ] [ plc_xy ] - up -> [ plc_xx ] [ esp ] < . up . > mqtt [ sensor ] - up -> [ plc_xx ] [ aktor ] <- up - [ plc_xx ] } @ enduml","title":"Components of the auto home stack"},{"location":"images/readme_plantuml/#legend","text":"@ startuml node \"Legend\" { package \"device\" { [ item 1 ] as TMS # Tomato } folder \"tst\" { [ item 2 ] as CM # Lime } } @ enduml","title":"legend"},{"location":"images/readme_plantuml/#node-red","text":"@ startuml [ * ] --> NodeRed udp -> NodeRed NodeRed -> udp udp : plc interface mqtt --> NodeRed NodeRed --> mqtt mqtt : field level devices \\ nesp 8266 , \\ nwatchdog services , ... iot --> NodeRed NodeRed --> iot iot : other interfaces \\ nlike rest apis , AWS S3 , \\ nssh to linux devices , \\ n ... NodeRed --> db db : MySQL and \\ nInfluxDB NodeRed : store all prozess \\ nand event data \\ nprozess data with rule engine \\ n @ enduml","title":"node red"},{"location":"images/readme_plantuml/#node_red-rule-engine","text":"@ startuml ( * ) --> new event If \"compare topic\" then --> [ matches ] \"create alarm\" --> send to receiver --> ( * ) else --> [ no match ] continue Endif --> ( * ) @ enduml","title":"node_red rule engine"},{"location":"level_control/control_system/","text":"Control system \u00b6 Grafana \u00b6 Using an open source solution is much easier than implementing a monitor dashboard yourself. I had good experiences with grafana . Out of the box even larger time ranges are displayed performant. Grafana is the open source analytics and monitoring solution for every database I can recommend this installation pages mqtt mosquitto \u00b6 Eclipse Mosquitto is an open source message broker that implements the MQTT protocol","title":"control_system"},{"location":"level_control/control_system/#control-system","text":"","title":"Control system"},{"location":"level_control/control_system/#grafana","text":"Using an open source solution is much easier than implementing a monitor dashboard yourself. I had good experiences with grafana . Out of the box even larger time ranges are displayed performant. Grafana is the open source analytics and monitoring solution for every database I can recommend this installation pages","title":"Grafana"},{"location":"level_control/control_system/#mqtt-mosquitto","text":"Eclipse Mosquitto is an open source message broker that implements the MQTT protocol","title":"mqtt mosquitto"},{"location":"level_control/dotNet_tool/","text":"PC tool for controlling / monitoring the system \u00b6 The PC-Tool is written in C# and was developed during the commissioning phase (which will probably not be finished that soon ;-) ). The tool has a fancy surface and is suitable for carrying out basic parameter settings on the controller. It turns out that it is uncomfortable to rely on a windows pc to control the system. If you are interested you can look at it references.md Here are some historical pics of the outdated dot net pc tool. All devices / sensors / actuators could be configured in a parameter window. Due to its generic structure, any actuators can be added during runtime and addressed in the controller. These can then be positioned in the ui by drag and drop With this view all actors of a selected type can be observed and controlled Clicking on a specific image either triggers an action or opens a sub window with further options To visualize past data from the data logger the tool has a sql client with dashboard","title":"dotNet tool"},{"location":"level_control/dotNet_tool/#pc-tool-for-controlling-monitoring-the-system","text":"The PC-Tool is written in C# and was developed during the commissioning phase (which will probably not be finished that soon ;-) ). The tool has a fancy surface and is suitable for carrying out basic parameter settings on the controller. It turns out that it is uncomfortable to rely on a windows pc to control the system. If you are interested you can look at it references.md Here are some historical pics of the outdated dot net pc tool. All devices / sensors / actuators could be configured in a parameter window. Due to its generic structure, any actuators can be added during runtime and addressed in the controller. These can then be positioned in the ui by drag and drop With this view all actors of a selected type can be observed and controlled Clicking on a specific image either triggers an action or opens a sub window with further options To visualize past data from the data logger the tool has a sql client with dashboard","title":"PC tool for controlling / monitoring the system"},{"location":"level_control/node_red/","text":"Node red \u00b6 As control system and for the connection of other devices I currently use node-RED . Node-RED is a programming tool for wiring together hardware devices, APIs and online services It has already implemented interfaces (which are called 'nodes') to a lot of devices I use. Dashboards \u00b6 It is easy to make quick dash boards to monitor the sensor and health state of the devices. Or to configure debug / control clients for different devices Rule engine \u00b6 The rule engine is a function node that is triggered by the receipt of any message. In this example rule a sensor event from the light barrier triggers the rule engine. If the weather station detects that it is dark two lights are switched on. var plc_cmd = []; var alarm_info = 'not_processed' ; if ( t . startsWith ( 'v01/esp/basement/i/' )){ let lux = global . get ( 'PD.esp_basement.lux' ); let switch_value = 150 if ( lux < switch_value ){ alarm_info = 'esp/basement switch light on' plc_cmd . push ({ payload : \"aktor/light/basement_floor/set_switch_value#on\" , topic : \"eg\" }); plc_cmd . push ({ payload : \"aktor/light/basement_stairs/set_switch_value#on\" , topic : \"eg\" }); } else { alarm_info = 'esp/basement motion but not dark [lux: ' + lux + '] > ' + switch_value ; } } // for logging or later use a new alarm is generated // and stored at the database if ( alarm_info !== 'not_processed' ){ msg . alarm = { topic : t , payload : p , status : 'created' , time_created : getFormattedDate (), info : alarm_info } let ret = t . replace ( 'v01' , 're' ); // the alarm and commands for the PLC s are returned for further processing msg . topic = \"INSERT INTO node_log(topic, message) VALUES ( \\\"\" + ret + \"\\\", \\\"\" + alarm_info + \" / \" + p + \"\\\" )\" return [ msg , plc_cmd ]; } Here are the log messages when the motion sensor is triggered some hints \u00b6 Initialising Variable var count = context . get ( 'count' ) || 0 ; var count2 = context . get ( 'count2' ) || 0 ; // You can also use an object e.g var local = context . get ( 'data' ) || {}; if ( local . count === undefined ) //test exists { local . count = 0 ; } my config \u00b6 Imported Nodes (Plugins) \u00b6 name usage node-red-dashboard frontend dashboard elements node-red-contrib-fritz get network device status / control guest wlan node-red-contrib-s7 connection to PLCs via S7 protocol, almost no longer in use (replaced by the udp protocol) node-red-node-mysql reading / writing to maria database node-red-contrib-os access to operating system bevore switching to docker node-red-contrib-mqtt-broker mqtt client node-red-node-email send alarm / notification e-mails node-red-contrib-netatmo todo check if outdated node-red-contrib-netatmo-dashboard getting netatmo weather station data from cloud-account node-red-contrib-viera control the Panasonic TV Downloads \u00b6 If you are interested in the flows you can find the download link at the references.","title":"Node RED"},{"location":"level_control/node_red/#node-red","text":"As control system and for the connection of other devices I currently use node-RED . Node-RED is a programming tool for wiring together hardware devices, APIs and online services It has already implemented interfaces (which are called 'nodes') to a lot of devices I use.","title":"Node red"},{"location":"level_control/node_red/#dashboards","text":"It is easy to make quick dash boards to monitor the sensor and health state of the devices. Or to configure debug / control clients for different devices","title":"Dashboards"},{"location":"level_control/node_red/#rule-engine","text":"The rule engine is a function node that is triggered by the receipt of any message. In this example rule a sensor event from the light barrier triggers the rule engine. If the weather station detects that it is dark two lights are switched on. var plc_cmd = []; var alarm_info = 'not_processed' ; if ( t . startsWith ( 'v01/esp/basement/i/' )){ let lux = global . get ( 'PD.esp_basement.lux' ); let switch_value = 150 if ( lux < switch_value ){ alarm_info = 'esp/basement switch light on' plc_cmd . push ({ payload : \"aktor/light/basement_floor/set_switch_value#on\" , topic : \"eg\" }); plc_cmd . push ({ payload : \"aktor/light/basement_stairs/set_switch_value#on\" , topic : \"eg\" }); } else { alarm_info = 'esp/basement motion but not dark [lux: ' + lux + '] > ' + switch_value ; } } // for logging or later use a new alarm is generated // and stored at the database if ( alarm_info !== 'not_processed' ){ msg . alarm = { topic : t , payload : p , status : 'created' , time_created : getFormattedDate (), info : alarm_info } let ret = t . replace ( 'v01' , 're' ); // the alarm and commands for the PLC s are returned for further processing msg . topic = \"INSERT INTO node_log(topic, message) VALUES ( \\\"\" + ret + \"\\\", \\\"\" + alarm_info + \" / \" + p + \"\\\" )\" return [ msg , plc_cmd ]; } Here are the log messages when the motion sensor is triggered","title":"Rule engine"},{"location":"level_control/node_red/#some-hints","text":"Initialising Variable var count = context . get ( 'count' ) || 0 ; var count2 = context . get ( 'count2' ) || 0 ; // You can also use an object e.g var local = context . get ( 'data' ) || {}; if ( local . count === undefined ) //test exists { local . count = 0 ; }","title":"some hints"},{"location":"level_control/node_red/#my-config","text":"","title":"my config"},{"location":"level_control/node_red/#imported-nodes-plugins","text":"name usage node-red-dashboard frontend dashboard elements node-red-contrib-fritz get network device status / control guest wlan node-red-contrib-s7 connection to PLCs via S7 protocol, almost no longer in use (replaced by the udp protocol) node-red-node-mysql reading / writing to maria database node-red-contrib-os access to operating system bevore switching to docker node-red-contrib-mqtt-broker mqtt client node-red-node-email send alarm / notification e-mails node-red-contrib-netatmo todo check if outdated node-red-contrib-netatmo-dashboard getting netatmo weather station data from cloud-account node-red-contrib-viera control the Panasonic TV","title":"Imported Nodes (Plugins)"},{"location":"level_control/node_red/#downloads","text":"If you are interested in the flows you can find the download link at the references.","title":"Downloads"},{"location":"level_control/raspberry_setup/","text":"Raspberry setup \u00b6 Docker \u00b6 Most of the control components are running as docker image on a raspberry. Here are a few steps to set up: enable ssh server copy your puplic key to the raspberry for easier access cat ~/.ssh/id_rsa.pub | ssh pi_name@192.168.xxx.xxx -p 22 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys' get docker ` sudo apt-get update && sudo apt-get upgrade -y ` ` curl -sSL https://get.docker.com | sh ` ` sudo usermod -aG docker $USER ` setup container mqtt mosquitto docker run -itd -p 1883 :1883 -p 9001 :9001 --name mosquitto_ah eclipse-mosquitto setup container node red Mind that as long as we run the mosquitto and node-red container at the same host the --link mosquitto_ah:broker is necessary. If changing the deployment to different machines update the node-red-mqtt-server from broker to the new ip address sudo chown -R 1000 :1000 /home/pi/.node-red docker run -it -p 1880 :1880 -p 7724 :7724/udp -p 7725 :7725/udp -v /home/pi/.node-red:/data --restart = always --name nodered_ah --link mosquitto_ah:broker nodered/node-red setup container grafana docker volume create grafana-storage docker run -d -p 3000 :3000 -v grafana-storage:/var/lib/grafana --name = grafana_ah grafana/grafana setup pi hole The network ad blocking / monitoring software pi-hole.net is not really connected to the home automation system but it is always a good idear to have control over your network. Script device_status.py \u00b6 Download \u00b6 This script device_status.py is executed from the main raspberry. Some unit tests are here available (I used pytest). dependencies: pip3 install paho-mqtt If not using python3 replace subprocess with commands Purpose \u00b6 Its purpose is to get the status (temperature, ram usage, ...) of devices with ssh interface. Results will be puplished at MQTT for further processing. current clients: ip name component 192.168.1.39 og_floor piCorePlayer 192.168.1.40 eg_living piCorePlayer 192.168.1.41 og_bath piCorePlayer 192.168.1.211 rpi4 node-red + other container 192.168.1.200 syn NAS and home automation server Usage \u00b6 copy this script to clients: scp ~/repo/path_to_script/device_status.py rpi:~ To trigger this script we setup a crontab entry which executes this script every 10 minutes crontab -e */10 * * * * /usr/bin/python /home/pi/device_status.py get logfile from rpi for debugging purpose scp rpi:~/device_status.log ~/Desktop/LOG_device_status.log","title":"Raspberry setup"},{"location":"level_control/raspberry_setup/#raspberry-setup","text":"","title":"Raspberry setup"},{"location":"level_control/raspberry_setup/#docker","text":"Most of the control components are running as docker image on a raspberry. Here are a few steps to set up: enable ssh server copy your puplic key to the raspberry for easier access cat ~/.ssh/id_rsa.pub | ssh pi_name@192.168.xxx.xxx -p 22 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys' get docker ` sudo apt-get update && sudo apt-get upgrade -y ` ` curl -sSL https://get.docker.com | sh ` ` sudo usermod -aG docker $USER ` setup container mqtt mosquitto docker run -itd -p 1883 :1883 -p 9001 :9001 --name mosquitto_ah eclipse-mosquitto setup container node red Mind that as long as we run the mosquitto and node-red container at the same host the --link mosquitto_ah:broker is necessary. If changing the deployment to different machines update the node-red-mqtt-server from broker to the new ip address sudo chown -R 1000 :1000 /home/pi/.node-red docker run -it -p 1880 :1880 -p 7724 :7724/udp -p 7725 :7725/udp -v /home/pi/.node-red:/data --restart = always --name nodered_ah --link mosquitto_ah:broker nodered/node-red setup container grafana docker volume create grafana-storage docker run -d -p 3000 :3000 -v grafana-storage:/var/lib/grafana --name = grafana_ah grafana/grafana setup pi hole The network ad blocking / monitoring software pi-hole.net is not really connected to the home automation system but it is always a good idear to have control over your network.","title":"Docker"},{"location":"level_control/raspberry_setup/#script-device_statuspy","text":"","title":"Script device_status.py"},{"location":"level_control/raspberry_setup/#download","text":"This script device_status.py is executed from the main raspberry. Some unit tests are here available (I used pytest). dependencies: pip3 install paho-mqtt If not using python3 replace subprocess with commands","title":"Download"},{"location":"level_control/raspberry_setup/#purpose","text":"Its purpose is to get the status (temperature, ram usage, ...) of devices with ssh interface. Results will be puplished at MQTT for further processing. current clients: ip name component 192.168.1.39 og_floor piCorePlayer 192.168.1.40 eg_living piCorePlayer 192.168.1.41 og_bath piCorePlayer 192.168.1.211 rpi4 node-red + other container 192.168.1.200 syn NAS and home automation server","title":"Purpose"},{"location":"level_control/raspberry_setup/#usage","text":"copy this script to clients: scp ~/repo/path_to_script/device_status.py rpi:~ To trigger this script we setup a crontab entry which executes this script every 10 minutes crontab -e */10 * * * * /usr/bin/python /home/pi/device_status.py get logfile from rpi for debugging purpose scp rpi:~/device_status.log ~/Desktop/LOG_device_status.log","title":"Usage"},{"location":"level_field/field_level/","text":"Field level \u00b6 Wetter station \u00b6 For the weather station I decided for the P03/3-Modbus from Elsner. With it I can get the weather data: Brightness (east, south and west sun), wind speed, temperature and precipitation. With the Modbus variant I want to keep the possibility open to connect several participants (in special room sensors) to the control system via the bus system. The heating system \u00b6 My heating consists of the 20qm solar collectors and the \"romantic\" stove in the living room as well as an ETA SH20 twin. During the installation I saw that a maintenance interface is attached to the display. On inquiry with the manufacturer I got the RS232 protocol and thus the possibility by a CM1241 to access it. Here the protocoll: Byte startsign: alwas \u2019{\u2019 == hex 0x7B Byte Servicekennung Byte Servicekennung Byte Anzahl der Nutzdatenbytes Byte Pr\u00fcfsumme: alle Nutzdatenbytes addiert, modulo 256 ab 6. Byte Nutzdaten last Byte stoppsign alwas \u2019}\u2019 == hex 0x7D settings of serial interface: 19200 Baud, 1 Startbit, 8 Datenbits, 1 Stoppbit, NoParity, NoHandshake Herewith I inform the heating control that it should send out the actual values cyclically: # SEND_PTP_start ( REQ := # cmd . eta_start , \"PORT\" := # CP_Adress , BUFFER := # frame_start ); # cmd . eta_start := FALSE ; # SEND_PTP_cmd ( REQ := # cmd . eta_cmd , \"PORT\" := # CP_Adress , BUFFER := # frame_cmd );","title":"devices"},{"location":"level_field/field_level/#field-level","text":"","title":"Field level"},{"location":"level_field/field_level/#wetter-station","text":"For the weather station I decided for the P03/3-Modbus from Elsner. With it I can get the weather data: Brightness (east, south and west sun), wind speed, temperature and precipitation. With the Modbus variant I want to keep the possibility open to connect several participants (in special room sensors) to the control system via the bus system.","title":"Wetter station"},{"location":"level_field/field_level/#the-heating-system","text":"My heating consists of the 20qm solar collectors and the \"romantic\" stove in the living room as well as an ETA SH20 twin. During the installation I saw that a maintenance interface is attached to the display. On inquiry with the manufacturer I got the RS232 protocol and thus the possibility by a CM1241 to access it. Here the protocoll: Byte startsign: alwas \u2019{\u2019 == hex 0x7B Byte Servicekennung Byte Servicekennung Byte Anzahl der Nutzdatenbytes Byte Pr\u00fcfsumme: alle Nutzdatenbytes addiert, modulo 256 ab 6. Byte Nutzdaten last Byte stoppsign alwas \u2019}\u2019 == hex 0x7D settings of serial interface: 19200 Baud, 1 Startbit, 8 Datenbits, 1 Stoppbit, NoParity, NoHandshake Herewith I inform the heating control that it should send out the actual values cyclically: # SEND_PTP_start ( REQ := # cmd . eta_start , \"PORT\" := # CP_Adress , BUFFER := # frame_start ); # cmd . eta_start := FALSE ; # SEND_PTP_cmd ( REQ := # cmd . eta_cmd , \"PORT\" := # CP_Adress , BUFFER := # frame_cmd );","title":"The heating system"},{"location":"level_field/iot_multisensor/","text":"IoT multisensor \u00b6 Install Arduino IDE \u00b6 The Arduino IDE from my debian package repository is very old. To get a newer version of the Arduino IDE got to the Official Website and download your package. cd ./Downloads sudo tar xvJf arduino-1.8.12-linux64.tar.xz -C /opt ls -lh /opt/ sudo -E /opt/arduino-1.8.12/install.sh Now, you have to add the Debian 10 login user to the dialout, tty, uucp and plugdev group. https://linuxhint.com/install_arduino_ide_debian_10/ ESP8266 \u00b6 To enable the esp8266 libs at Arduino IDE Go to File > Preferences -> Additional Board Manager URLs: http://arduino.esp8266.com/stable/package_esp8266com_index.json Tools > Board -> Boards Manager -> Search for ESP8266 and install Dependency libs: git clone https://github.com/knolleary/pubsubclient.git git clone https://github.com/adafruit/DHT-sensor-library.git copy to ~/Arduino/libraries Features: read temperatur / humility and publish cyclic read light lux and publish cyclic detect motion and publish at detection (on rising edge) MQTT Interface subscription topics (start with prefix(v01/esp/) + esp_name + topic_type) e.g. v01/esp/nodeMCUIBS/config/get_status topic meaning /config/echo just send an reply /config/get_status[value: \"\"; status; prozess; heap] /config/set_name [new name] change name of esp (with prefix for topics) /config/send_intervall_sensor [new time in ms] e.g. \"10000\" for 10s /config/send_intervall_status watchdog with status information /config/reset [dht, setup, vars] NodeMCU GPIO \u00b6 node gpio pinout digitalWrite did NOT work with GPIOs 6, 7, 8, 11, and ADC (A0) digitalRead did NOT work with GPIOs 1, 3, 6, 7, 8, 11, and the ADC (A0) GPIO sensoric \u00b6 pin DHT22 AM312 KY-018 1 VCC VCC GND 2 DATA=D7 OUT=D2/D5 VCC 3 nc GND DATA=A0 4 GND NODE mcu platine soldered \u00b6 GPIO platine-color device D2 orange pir 1 -> pin_2 (stairs) D5 yellow pir 2 -> pin_2 (corridor) 3V red pir1/2 -> pin_1 3V violett pir1/2 -> pin_1 gnd blue pir1/2 -> pin_3 gnd grey pir1/2 -> pin_3 A0 green S g yellow middle VV orange - D7 grey DHT_2 3V black DHT_1 g white DHT_4 NODE mcu general \u00b6 GPIO device GPIO device A0 KY-S [black] D0 G KY-middle [brown] D1 VV KY - [red] D2 pir middle [orange] S3 D3 S2 D4 S1 3V SC G S0 D5 pir middle [yellow] SK D6 G pir 3 [red/grey] D7 DHT22 2 (signal) [orange] 3V pir 1 [blue/green] D8 EN RX RST TX G G DHT22 4 [red] VIN 3V DHT22 1 [brown] - === === - 3D case \u00b6 This is the 3D model of the case Natural environment \u00b6 Here you can see the sensor in the wild and here the inside of it Downloads \u00b6 You can download the STL file here: new_multisensor_V0.1 The arduino sketch is stored here: ah_iot_multisensor_v06","title":"IoT Multisensor"},{"location":"level_field/iot_multisensor/#iot-multisensor","text":"","title":"IoT multisensor"},{"location":"level_field/iot_multisensor/#install-arduino-ide","text":"The Arduino IDE from my debian package repository is very old. To get a newer version of the Arduino IDE got to the Official Website and download your package. cd ./Downloads sudo tar xvJf arduino-1.8.12-linux64.tar.xz -C /opt ls -lh /opt/ sudo -E /opt/arduino-1.8.12/install.sh Now, you have to add the Debian 10 login user to the dialout, tty, uucp and plugdev group. https://linuxhint.com/install_arduino_ide_debian_10/","title":"Install Arduino IDE"},{"location":"level_field/iot_multisensor/#esp8266","text":"To enable the esp8266 libs at Arduino IDE Go to File > Preferences -> Additional Board Manager URLs: http://arduino.esp8266.com/stable/package_esp8266com_index.json Tools > Board -> Boards Manager -> Search for ESP8266 and install Dependency libs: git clone https://github.com/knolleary/pubsubclient.git git clone https://github.com/adafruit/DHT-sensor-library.git copy to ~/Arduino/libraries Features: read temperatur / humility and publish cyclic read light lux and publish cyclic detect motion and publish at detection (on rising edge) MQTT Interface subscription topics (start with prefix(v01/esp/) + esp_name + topic_type) e.g. v01/esp/nodeMCUIBS/config/get_status topic meaning /config/echo just send an reply /config/get_status[value: \"\"; status; prozess; heap] /config/set_name [new name] change name of esp (with prefix for topics) /config/send_intervall_sensor [new time in ms] e.g. \"10000\" for 10s /config/send_intervall_status watchdog with status information /config/reset [dht, setup, vars]","title":"ESP8266"},{"location":"level_field/iot_multisensor/#nodemcu-gpio","text":"node gpio pinout digitalWrite did NOT work with GPIOs 6, 7, 8, 11, and ADC (A0) digitalRead did NOT work with GPIOs 1, 3, 6, 7, 8, 11, and the ADC (A0)","title":"NodeMCU GPIO"},{"location":"level_field/iot_multisensor/#gpio-sensoric","text":"pin DHT22 AM312 KY-018 1 VCC VCC GND 2 DATA=D7 OUT=D2/D5 VCC 3 nc GND DATA=A0 4 GND","title":"GPIO sensoric"},{"location":"level_field/iot_multisensor/#node-mcu-platine-soldered","text":"GPIO platine-color device D2 orange pir 1 -> pin_2 (stairs) D5 yellow pir 2 -> pin_2 (corridor) 3V red pir1/2 -> pin_1 3V violett pir1/2 -> pin_1 gnd blue pir1/2 -> pin_3 gnd grey pir1/2 -> pin_3 A0 green S g yellow middle VV orange - D7 grey DHT_2 3V black DHT_1 g white DHT_4","title":"NODE mcu platine soldered"},{"location":"level_field/iot_multisensor/#node-mcu-general","text":"GPIO device GPIO device A0 KY-S [black] D0 G KY-middle [brown] D1 VV KY - [red] D2 pir middle [orange] S3 D3 S2 D4 S1 3V SC G S0 D5 pir middle [yellow] SK D6 G pir 3 [red/grey] D7 DHT22 2 (signal) [orange] 3V pir 1 [blue/green] D8 EN RX RST TX G G DHT22 4 [red] VIN 3V DHT22 1 [brown] - === === -","title":"NODE mcu general"},{"location":"level_field/iot_multisensor/#3d-case","text":"This is the 3D model of the case","title":"3D case"},{"location":"level_field/iot_multisensor/#natural-environment","text":"Here you can see the sensor in the wild and here the inside of it","title":"Natural environment"},{"location":"level_field/iot_multisensor/#downloads","text":"You can download the STL file here: new_multisensor_V0.1 The arduino sketch is stored here: ah_iot_multisensor_v06","title":"Downloads"},{"location":"level_process/dataLoggerServer/","text":"dataLoggerServer \u00b6 During the early implementing phase of the home automation system i needed some logging mechanism for bug finding. And after implementing this interface at the plc and i kept it for data logging. Meanwhile the usual data logging is realized within the control system (node red) but for redundancy purpose the mechanism is still alive. The main script provides a IP listener for every configuret plc connection. Messages from the remote clients will be parsed and stored in a db.","title":"Data logger"},{"location":"level_process/dataLoggerServer/#dataloggerserver","text":"During the early implementing phase of the home automation system i needed some logging mechanism for bug finding. And after implementing this interface at the plc and i kept it for data logging. Meanwhile the usual data logging is realized within the control system (node red) but for redundancy purpose the mechanism is still alive. The main script provides a IP listener for every configuret plc connection. Messages from the remote clients will be parsed and stored in a db.","title":"dataLoggerServer"},{"location":"level_process/plc_program/","text":"Processing level \u00b6 My focus was on a generic solution in order to be able to extend the control program easily or to port it to another environment without major adaptations. Simatic Project library \u00b6 For basic functions which are performed in more then one plc I maintain the code in the TIA Project library . Actuator \u00b6 Here is an example of the light building block. This is called several times in a superimposed \"control\" block. ash became light IF # turn_on THEN # switch_signal := true ; END_IF ; # Tturn_off ( IN := # turn_off , PT := t # 5 s , Q => # tmp_turn_off_hold ); IF # param . \"auto-off_lux_enable\" THEN # \"Tauto-off-lux\" ( IN := \"sense_lux_stairs_og\" > # param . \"auto-off_lux\" , PT := t # 10 s , Q => # tmp_turn_off_lux ); END_IF ; Since the interior of the house took place over the winter, I realized the light building block first. The module has one input to change the output signal and one input to switch it on and one input to switch it off. The output switches directly the coupling relay which controls the physical light. In the \"inner life\" of the module there is a delay to prevent the rear switching on/off (I implemented this function because of a stress test of my kids). In addition there is a timer which switches off the light after a configured time and the possibility to also switch off the light if a brightness value is exceeded. and getting dark again The blind building block was a little trickier. Because I can't evaluate the signal of the physical end stop in the control I measured the time of the up and down movement. The target position and the target angle of the slats (each in 0 - 100%) are transferred to an extra \"blind motor\" module. In this module, the time of the actual position and the actual angle is continuously normalized and the target values are approached in a state machine. In addition, I have locked a simultaneous up and down signal at the outputs at different positions. // normierung der position/zeit zwischen 0 - 100 # cur_data . position := REAL_TO_INT ( NORM_X ( MIN := 0 , VALUE := # cur_data . position_in_time , MAX := # DRIVING_TIME_POSITION ) * # DIGIT_SCALA ); # cur_data . angle := REAL_TO_INT ( NORM_X ( MIN := 0 , VALUE := # cur_data . angle_in_time , MAX := # DRIVING_TIME_ANGLE ) * # DIGIT_SCALA ); END_IF ; The blind module has the following features: When the up/down button is pressed briefly, the blind moves to the respective end position (i.e. completely up or completely down). If the blind is moving and the up/down button is pressed again, the motor stops. If a button is pressed for a longer period of time (> 300ms have become established), the motor moves until the button is released again. Automatic startup when a parameterized wind speed is exceeded (measured by the weather station) Time-controlled approach of a position and an angle (I have planned 10 events so far but needed a maximum of 4) still on the TO-DO list: event-based approaching of an angle due to solar radiation and room temperature heating module The heating module is kept simpler again. Due to the relatively sluggish wall heating, I have not yet implemented an exact regulation of the heating circuits. In order to avoid a constant toggling the servomotors switch off only with 0,5 degrees over target. In addition, an interval can be parameterized if the temperature falls below the target value and the time of day during which the module is to be active. For IBS purposes (and e.g. vacation time), the PC-Tool can also be used to switch to manual mode (defined on or off). TO-DO Current I have not yet realized the socket module. Currently I only switch the sockets in the children's room. Since here however a bedside lamp is switched I also used the light component for it. Data ingest \u00b6 Data logger \u00b6 The data logger client communicates via the TCP/IP protocol with the server running on the NAS. NodeUdp \u00b6 Simatic program \u00b6 For each actuator type (light, jalouse, socket, heating) there is a general function module that is instantiated for each device. communication udp \u00b6 For external communication each PLC contains a net_interface block. Here a UDP/IP server is realized in a state machine which can be addressed e.g. via the PC-Tool. Each instance of an actuator block is given a unique ID. This ID can also be found in the PC tool. communication plc <-> plc \u00b6 The actual rule engine (which is currently implemented via node-red on a raspberry) is running stable so far. Hint Nevertheless it should be guaranteed that some important functions are available even if the rule engine fails. For example, the blinds on the ground floor must be raised in the event of a storm warning. Therefore it is necessary that the plcs exchange selected signals directly. The plc on the ground floor uses the GET module to read the current wind speed from the plc on the upper floor # GET_sensor_values ( REQ := # next_cycle_flag , ID := W # 16 # 100 , ADDR_1 := P # DB80 . DBX0 .0 BYTE 4 , RD_1 := # remote_sensor_weather_wind );","title":"PLC program"},{"location":"level_process/plc_program/#processing-level","text":"My focus was on a generic solution in order to be able to extend the control program easily or to port it to another environment without major adaptations.","title":"Processing level"},{"location":"level_process/plc_program/#simatic-project-library","text":"For basic functions which are performed in more then one plc I maintain the code in the TIA Project library .","title":"Simatic Project library"},{"location":"level_process/plc_program/#actuator","text":"Here is an example of the light building block. This is called several times in a superimposed \"control\" block. ash became light IF # turn_on THEN # switch_signal := true ; END_IF ; # Tturn_off ( IN := # turn_off , PT := t # 5 s , Q => # tmp_turn_off_hold ); IF # param . \"auto-off_lux_enable\" THEN # \"Tauto-off-lux\" ( IN := \"sense_lux_stairs_og\" > # param . \"auto-off_lux\" , PT := t # 10 s , Q => # tmp_turn_off_lux ); END_IF ; Since the interior of the house took place over the winter, I realized the light building block first. The module has one input to change the output signal and one input to switch it on and one input to switch it off. The output switches directly the coupling relay which controls the physical light. In the \"inner life\" of the module there is a delay to prevent the rear switching on/off (I implemented this function because of a stress test of my kids). In addition there is a timer which switches off the light after a configured time and the possibility to also switch off the light if a brightness value is exceeded. and getting dark again The blind building block was a little trickier. Because I can't evaluate the signal of the physical end stop in the control I measured the time of the up and down movement. The target position and the target angle of the slats (each in 0 - 100%) are transferred to an extra \"blind motor\" module. In this module, the time of the actual position and the actual angle is continuously normalized and the target values are approached in a state machine. In addition, I have locked a simultaneous up and down signal at the outputs at different positions. // normierung der position/zeit zwischen 0 - 100 # cur_data . position := REAL_TO_INT ( NORM_X ( MIN := 0 , VALUE := # cur_data . position_in_time , MAX := # DRIVING_TIME_POSITION ) * # DIGIT_SCALA ); # cur_data . angle := REAL_TO_INT ( NORM_X ( MIN := 0 , VALUE := # cur_data . angle_in_time , MAX := # DRIVING_TIME_ANGLE ) * # DIGIT_SCALA ); END_IF ; The blind module has the following features: When the up/down button is pressed briefly, the blind moves to the respective end position (i.e. completely up or completely down). If the blind is moving and the up/down button is pressed again, the motor stops. If a button is pressed for a longer period of time (> 300ms have become established), the motor moves until the button is released again. Automatic startup when a parameterized wind speed is exceeded (measured by the weather station) Time-controlled approach of a position and an angle (I have planned 10 events so far but needed a maximum of 4) still on the TO-DO list: event-based approaching of an angle due to solar radiation and room temperature heating module The heating module is kept simpler again. Due to the relatively sluggish wall heating, I have not yet implemented an exact regulation of the heating circuits. In order to avoid a constant toggling the servomotors switch off only with 0,5 degrees over target. In addition, an interval can be parameterized if the temperature falls below the target value and the time of day during which the module is to be active. For IBS purposes (and e.g. vacation time), the PC-Tool can also be used to switch to manual mode (defined on or off). TO-DO Current I have not yet realized the socket module. Currently I only switch the sockets in the children's room. Since here however a bedside lamp is switched I also used the light component for it.","title":"Actuator"},{"location":"level_process/plc_program/#data-ingest","text":"","title":"Data ingest"},{"location":"level_process/plc_program/#data-logger","text":"The data logger client communicates via the TCP/IP protocol with the server running on the NAS.","title":"Data logger"},{"location":"level_process/plc_program/#nodeudp","text":"","title":"NodeUdp"},{"location":"level_process/plc_program/#simatic-program","text":"For each actuator type (light, jalouse, socket, heating) there is a general function module that is instantiated for each device.","title":"Simatic program"},{"location":"level_process/plc_program/#communication-udp","text":"For external communication each PLC contains a net_interface block. Here a UDP/IP server is realized in a state machine which can be addressed e.g. via the PC-Tool. Each instance of an actuator block is given a unique ID. This ID can also be found in the PC tool.","title":"communication udp"},{"location":"level_process/plc_program/#communication-plc-plc","text":"The actual rule engine (which is currently implemented via node-red on a raspberry) is running stable so far. Hint Nevertheless it should be guaranteed that some important functions are available even if the rule engine fails. For example, the blinds on the ground floor must be raised in the event of a storm warning. Therefore it is necessary that the plcs exchange selected signals directly. The plc on the ground floor uses the GET module to read the current wind speed from the plc on the upper floor # GET_sensor_values ( REQ := # next_cycle_flag , ID := W # 16 # 100 , ADDR_1 := P # DB80 . DBX0 .0 BYTE 4 , RD_1 := # remote_sensor_weather_wind );","title":"communication plc &lt;-&gt; plc"},{"location":"level_process/simatic_plc/","text":"The hardware \u00b6 For monitoring and control of most hard-wired sensor/actuator devices I use Siemens Simatic Series 1200 PLCs. These are actually used in industrial environments (so they meet my requirements regarding robustness) and were priced within my budget. The picture shows a sub-distributor during the construction phase. Right beside the multimeter you can see a 1214C PLC with 3x DI/DO expansion modules. The PLCs are programmed with SCL (Structured Control Language), which has a Pascal-like syntax. In the following I describe the user program in excerpts.","title":"Simatic PLC"},{"location":"level_process/simatic_plc/#the-hardware","text":"For monitoring and control of most hard-wired sensor/actuator devices I use Siemens Simatic Series 1200 PLCs. These are actually used in industrial environments (so they meet my requirements regarding robustness) and were priced within my budget. The picture shows a sub-distributor during the construction phase. Right beside the multimeter you can see a 1214C PLC with 3x DI/DO expansion modules. The PLCs are programmed with SCL (Structured Control Language), which has a Pascal-like syntax. In the following I describe the user program in excerpts.","title":"The hardware"},{"location":"multiroom/my_multiroom/","text":"The multiroom setup \u00b6 For my multiroom system I used Raspberry PI's, a Russound amplifier and Dali speakers. As \"remote control\" should work every device (PC/Tablet/Smartphone) with a UPNP client/App. In my central solution I have laid all the speaker cables from the different rooms to the network cabinet. With later implementation, a decentralized solution would also be possible. In case of LAN and power supply the Raspberry and the amplifier could disappear in the wall/ceiling next to the speaker. Here you see the network cabinet with tree raspberrys as media-player and the amplifier. Media-player \u00b6 As in (almost) every modern household, no Raspberry PI should be missing. On the Raspberry there is a digital/analog converter from hifiberry.com plugged in, which feeds its signal into the amplifier. As media player software I use piCorePlayer which is a tiny core linux distribution running entirely in RAM. For remote controll for the Logitech Media Server I use the app squeezer. It supports my Spotify account I can listen from my (local stored at synology NAS) own music collection I can choose from internet radio stations In the app I can select in which zone the music is played And I can manage the playlist and synchronize the players if necessary Amplifier \u00b6 After a long time of informing myself I ordered a refurbished Russound M850MC 8-channel amplifier from America via e-bay. R850MC_connections With its 19-inch format, it fits perfectly into the network cabinet and supplies the entire house in its current configuration. The living room and the kitchen are controlled in parallel via a single Raspberry. Speaker \u00b6 For the loudspeakers (built-in speakers in plaster cardboard) I chose the PHANTOM series of the company Dali. In the living room I installed the IKON in the bathroom ceiling the PHANTOM-E-60 and in the hallway the PHANTOM-H-50. In the kitchen there was little space in the wall and so the wall unit was the perfect place to put the compact box ZENSOR-3 on it. Synology server \u00b6 hosting the Logitech Media Server LMS","title":"multiroom"},{"location":"multiroom/my_multiroom/#the-multiroom-setup","text":"For my multiroom system I used Raspberry PI's, a Russound amplifier and Dali speakers. As \"remote control\" should work every device (PC/Tablet/Smartphone) with a UPNP client/App. In my central solution I have laid all the speaker cables from the different rooms to the network cabinet. With later implementation, a decentralized solution would also be possible. In case of LAN and power supply the Raspberry and the amplifier could disappear in the wall/ceiling next to the speaker. Here you see the network cabinet with tree raspberrys as media-player and the amplifier.","title":"The multiroom setup"},{"location":"multiroom/my_multiroom/#media-player","text":"As in (almost) every modern household, no Raspberry PI should be missing. On the Raspberry there is a digital/analog converter from hifiberry.com plugged in, which feeds its signal into the amplifier. As media player software I use piCorePlayer which is a tiny core linux distribution running entirely in RAM. For remote controll for the Logitech Media Server I use the app squeezer. It supports my Spotify account I can listen from my (local stored at synology NAS) own music collection I can choose from internet radio stations In the app I can select in which zone the music is played And I can manage the playlist and synchronize the players if necessary","title":"Media-player"},{"location":"multiroom/my_multiroom/#amplifier","text":"After a long time of informing myself I ordered a refurbished Russound M850MC 8-channel amplifier from America via e-bay. R850MC_connections With its 19-inch format, it fits perfectly into the network cabinet and supplies the entire house in its current configuration. The living room and the kitchen are controlled in parallel via a single Raspberry.","title":"Amplifier"},{"location":"multiroom/my_multiroom/#speaker","text":"For the loudspeakers (built-in speakers in plaster cardboard) I chose the PHANTOM series of the company Dali. In the living room I installed the IKON in the bathroom ceiling the PHANTOM-E-60 and in the hallway the PHANTOM-H-50. In the kitchen there was little space in the wall and so the wall unit was the perfect place to put the compact box ZENSOR-3 on it.","title":"Speaker"},{"location":"multiroom/my_multiroom/#synology-server","text":"hosting the Logitech Media Server LMS","title":"Synology server"}]}